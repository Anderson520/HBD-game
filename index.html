<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â∞èÂØ∏Â∞çÊ±∫</title>
    <style>
        :root { --p1-color: #ff85a2; --p2-color: #4cc9f0; --accent-color: #f72585; --bg-color: #fff5f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        #status-bar { margin-top: 15px; font-size: 18px; font-weight: bold; color: #333; height: 30px; text-align: center; }
        
        #player-info { display: flex; gap: 10px; margin: 10px 0; }
        .p-tag { padding: 6px 12px; border-radius: 20px; font-size: 12px; background: white; border: 2px solid #ddd; transition: 0.3s; color: #888; position: relative; }
        .p-tag.active.p1-active { border-color: var(--p1-color); background: var(--p1-color); color: white; transform: scale(1.1); }
        .p-tag.active.p2-active { border-color: var(--p2-color); background: var(--p2-color); color: white; transform: scale(1.1); }
        .status-badge { position: absolute; top: -10px; right: -5px; font-size: 9px; background: #ff4d4d; color: white; padding: 2px 5px; border-radius: 8px; }

        #game-container { position: relative; width: 92vw; height: 92vw; max-width: 400px; max-height: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 10px; }
        .board { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); gap: 4px; width: 100%; height: 100%; }
        .cell { background: #fff0f3; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 11px; border: 1px solid #ffdeeb; position: relative; font-weight: bold; text-align: center; padding: 2px; }
        .cell.special { background: #ffd166; color: #555; border-color: #f4a261; }
        .cell.upgrade { background: #06d6a0; color: white; border-color: #059669; }
        .cell.start { background: var(--accent-color); color: white; }
        
        .player-token { position: absolute; width: 32px; height: 32px; z-index: 10; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .player-token.mini { transform: scale(0.6); opacity: 0.8; }

        .dice-box { width: 70px; height: 70px; background: white; border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: bold; color: var(--accent-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid var(--accent-color); margin: 15px 0; cursor: pointer; }
        .rolling-anim { animation: shake 0.1s infinite; color: #ccc; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        
        #reset-btn { background: #aaa; color: white; border: none; padding: 8px 20px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-bottom: 10px; }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 20px; text-align: center; }
        .modal-content img { width: 100%; max-height: 220px; border-radius: 12px; margin-bottom: 12px; object-fit: cover; display: none; }
        #modal-text { font-size: 16px; line-height: 1.5; color: #444; margin: 10px 0; font-weight: 500; }
        #close-btn { background: var(--accent-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 16px; width: 100%; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="status-bar">Ê∫ñÂÇôÂ•ΩÈñãÂßã‰∫ÜÂóéÔºü</div>
    <div id="player-info">
        <div id="p1-tag" class="p-tag p1-active active">P1: Â∞èÂØ∏Â≠ê (D4) <span id="p1-status"></span></div>
        <div id="p2-tag" class="p-tag p2-active">P2: Â∞èÂØ∏Â≠ê (D4) <span id="p2-status"></span></div>
    </div>

    <div id="game-container">
        <img id="p1-token" class="player-token" src="me.png" onerror="this.src='https://ui-avatars.com/api/?name=P1&background=ff85a2&color=fff'">
        <img id="p2-token" class="player-token" src="you.png" onerror="this.src='https://ui-avatars.com/api/?name=P2&background=4cc9f0&color=fff'">
        <div class="board" id="board"></div>
    </div>

    <div class="dice-box" id="dice-btn">?</div>
    <button id="reset-btn">ÈáçÊñ∞ÂïüÂãïÈÅäÊà≤</button>

    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color: var(--accent-color); margin: 0 0 10px 0;"></h3>
            <img id="modal-img" src="">
            <div id="modal-text"></div>
            <button id="close-btn">ÁπºÁ∫åÂâçÈÄ≤</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // --- 1. ÈÖçÁΩÆÂçÄÂüü ---
        const mapPhotos = ["p1.jpeg", "p2.jpeg", "p3.jpeg", "p4.jpeg", "p5.jpeg", "p6.jpeg", "p7.jpeg", "p8.jpeg", "p9.jpeg", "p10.jpeg"];
        const mapTexts = ["Êñ∞Âä†Âù°ÂãïÁâ©ÂúíÈÅáË¶ãÁãêÁå¥ Ë∂ÖËêåÔºÅ", "Áí∞ÁêÉÂ•áÊÄ™Ëá™Êãç", "Êñ∞Âä†Âù°ÂêàÁÖß ÂÖÑÂºüÊâãÊ∞£ÁàÜÊ£ö", "......", "ÂÖßË°£Â§ßÁõú", "Á¨¨‰∏ÄÊ¨°‰∏ÄËµ∑ÊªëÈõ™ÔºåÂ•ΩÁé©ÔºÅ", "ÊàêÁÇ∫ËñØÁ≤â", "Ë¢´Â∞èÂçóÂØµÂπ∏", "‰∏ÄËµ∑Â†ÜÁöÑÈõ™Âú∞Â∞èÁôΩ", "ÈÄôÂºµÁ¥îÁ≤πÂà∑Âà∞ ÂæàÂ•ΩÁ¨ëÂìà"];

        const eventPhotos = {
            mini: "e1.jpeg",    // ÂÅáÂÜíÂØ∏Á•û -
            tired: "e2.jpeg",   // Á¥ØÁ¥ØÁóÖ -
            scratch: "e3.jpeg", // ÊäìËÉå -
            pokemon: "e4.jpeg", // ÊäìÂØ∂ -
            nuo: "e5.jpeg",     // Â∞èË´æ -
            racing: "e6.jpeg",  // È£ÜËªä - 
            ceng: "e7.jpeg"     // Ëπ≠Â≠ê -
        };

        // --- 2. ÈÅäÊà≤Ê†∏ÂøÉËÆäÊï∏ ---
        let players = [
            { id: 1, pos: 0, dice: 4, token: 'p1-token', tag: 'p1-tag', skipTurns: 0, fixedSteps: 0, reverseNext: false },
            { id: 2, pos: 0, dice: 4, token: 'p2-token', tag: 'p2-tag', skipTurns: 0, fixedSteps: 0, reverseNext: false }
        ];
        let currentPlayerIdx = 0;
        let isMoving = false;
        const totalCells = 20;
        const layout = ['Start','M','S','M','M','S','U','M','S','M','S','M','M','S','U','M','S','M','S','M'];
        const gridMap = [[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[6,5],[6,4],[6,3],[6,2],[6,1],[5,1],[4,1],[3,1],[2,1]];

        function initBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            let mIdx = 0;
            layout.forEach((type, i) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridRow = gridMap[i][0];
                cell.style.gridColumn = gridMap[i][1];
                if(type === 'Start') { cell.innerText = "START"; cell.classList.add('start'); }
                else if(type === 'S') { cell.innerText = "Ôºü"; cell.classList.add('special'); }
                else if(type === 'U') { cell.innerText = "UP"; cell.classList.add('upgrade'); }
                else { cell.innerText = "‚ù§"; cell.dataset.mIdx = mIdx % mapPhotos.length; mIdx++; }
                boardEl.appendChild(cell);
            });
            updateTokens();
            updateUI();
        }

        // --- 3. Êì≤È™∞Â≠êËàáÁßªÂãïÈÇèËºØ ---
        document.getElementById('dice-btn').onclick = function() {
            if(isMoving) return;
            let p = players[currentPlayerIdx];

            if(p.skipTurns > 0) {
                p.skipTurns--;
                showModal("Á§æÂçÄÊúçÂãô‰∏≠...", eventPhotos.mini, `ÈÇÑÈúÄË¶ÅÊúçÂàë ${p.skipTurns + 1} ÂõûÂêà„ÄÇ`);
                document.getElementById('close-btn').onclick = () => {
                    document.getElementById('modal').style.display = 'none';
                    nextTurn();
                };
                return;
            }

            this.classList.add('rolling-anim');
            let counter = 0;
            let rollInterval = setInterval(() => {
                this.innerText = Math.floor(Math.random() * p.dice) + 1;
                if(++counter > 10) {
                    clearInterval(rollInterval);
                    let finalRoll = Math.floor(Math.random() * p.dice) + 1;
                    if(p.fixedSteps > 0) { p.fixedSteps--; finalRoll = 1; }
                    if(p.reverseNext) { p.reverseNext = false; finalRoll = -finalRoll; }
                    this.innerText = Math.abs(finalRoll);
                    this.classList.remove('rolling-anim');
                    movePlayer(p, finalRoll, true);
                }
            }, 80);
        };

        async function movePlayer(p, steps, triggerLanding = true) {
            isMoving = true;
            let direction = steps > 0 ? 1 : -1;
            let count = Math.abs(steps);

            for(let i=0; i<count; i++) {
                p.pos = (p.pos + direction + totalCells) % totalCells;
                updateTokens();
                if(p.pos === 0) {
                    if(direction === 1) { 
                        const win = await upgradeLogic(p, "È†ÜÂà©ÁπûÂÆå‰∏ÄÂúàÔºÅ"); 
                        if(win) return; 
                    } else { 
                        await downgradeLogic(p); 
                    }
                }
                await new Promise(r => setTimeout(r, 280));
            }
            if(triggerLanding) handleLanding(p);
        }

        function handleLanding(p) {
            const type = layout[p.pos];
            if(type === 'U') {
                upgradeLogic(p, "ÂçáÊ§çÔºÅ").then(win => { if(!win) nextTurn(); });
            } else if(type === 'S') {
                triggerRandomEvent(p);
            } else if(document.getElementsByClassName('cell')[p.pos].dataset.mIdx !== undefined) {
                const idx = document.getElementsByClassName('cell')[p.pos].dataset.mIdx;
                showModal("ÊàëÂÄë‰∏ÄËµ∑...", mapPhotos[idx], mapTexts[idx]);
                document.getElementById('close-btn').onclick = () => { document.getElementById('modal').style.display = 'none'; nextTurn(); };
            } else {
                nextTurn();
            }
        }

        // --- 4. Èö®Ê©ü‰∫ã‰ª∂ÈÇèËºØ (Âê´ÁÖßÁâá) ---
        function triggerRandomEvent(p) {
            const events = [
                {
                    f: () => {
                        p.skipTurns = 2;
                        showModal("ÂÅáÂÜíÂØ∏Á•ûÔºåË¢´Ë≤∂ÁÇ∫Ëø∑‰Ω†ÂØ∏", eventPhotos.mini, "‰∏ãÂÖ©ÂõûÂêà‰∏çËÉΩÊì≤È™∞Â≠êÔºöÁ§æÂçÄÊúçÂãô‰∏≠...");
                    }
                },
                {
                    f: () => {
                        p.fixedSteps = 3;
                        showModal("Á¥ØÁ¥ØÁóÖÁôº‰Ωú", eventPhotos.tired, "‰∏ã‰∏âÂõûÂêàÂè™ËÉΩËµ∞‰∏ÄÊ≠•„ÄÇ");
                    }
                },
                {
                    f: () => {
                        const opp = players[1 - currentPlayerIdx];
                        showModal("Êèê‰æõÊäìËÉåÊúçÂãô", eventPhotos.scratch, "Ëá™Â∑±ÂçáÁ¥öÔºåÂ∞çÊñπÂâçÈÄ≤‰∏âÊ†ºÔºÅ");
                        upgradeLogic(p, "ÊäìËÉåÁçéÂãµ");
                        movePlayer(opp, 3, false);
                    }
                },
                {
                    f: () => {
                        p.reverseNext = true;
                        showModal("Ê≤àËø∑ÊäìÂØ∂Ëø∑Ë∑Ø‰∫Ü", eventPhotos.pokemon, "‰∏ãÂõûÂêàËá™Â∑±ÂæÄÂæåËµ∞„ÄÇ");
                    }
                },
                {
                    f: () => {
                        showModal("Ë¢´Â∞èË´æÈ®∑ÊìæËÄΩË™§", eventPhotos.nuo, "ÂæÄÂæåÈÄÄ 3 Ê†º„ÄÇ");
                        setTimeout(() => movePlayer(p, -3, true), 800);
                        return true;
                    }
                },
                {
                    f: () => {
                        showModal("È£ÜËªäÔºÅ", eventPhotos.racing, "ÂÖ©‰∫∫‰∏ÄËµ∑ÂâçÈÄ≤ 4 Ê†ºÔºÅ");
                        movePlayer(players[0], 4, false);
                        movePlayer(players[1], 4, false);
                    }
                },
                {
                    f: () => {
                        showModal("ÂíåËπ≠Â≠êÁé©", eventPhotos.ceng, "‰ªÄÈ∫º‰∫ãÈÉΩÊ≤íÁôºÁîüÔºå‰ΩÜÂæàÂèØÊÑõ„ÄÇ");
                    }
                }
            ];

            const ev = events[Math.floor(Math.random() * events.length)];
            const isAsync = ev.f();
            document.getElementById('close-btn').onclick = () => {
                document.getElementById('modal').style.display = 'none';
                if(!isAsync) nextTurn();
            };
        }

        // --- 5. ÂçáÈôçÁ¥öËàá UI ---
        // Âª∫Á´ã‰∏ÄÂÄãÈöéÁ¥öÂ∞çÁÖßË°®
        const rankNames = {
            4: "Â∞èÂØ∏Â≠ê",
            6: "ÂØ∏Ê§ç",
            10: "Â§ßÊ§ç",
            15: "ÂØ¶ÁøíÂØ∏Á•û"
        };

        async function upgradeLogic(p, reason) {
            // Â¶ÇÊûúÂ∑≤Á∂ìÊòØÂØ¶ÁøíÂØ∏Á•ûÔºåÂÜçÊ¨°ÂçáÁ¥öÂ∞±ÂãùÂà©
            if(p.dice === 15) { victory(p); return true; }
            
            const nextLv = { 4: 6, 6: 10, 10: 15 };
            p.dice = nextLv[p.dice];
            const newRank = rankNames[p.dice];
            
            updateUI();
            
            // È°ØÁ§∫ÂçáÁ¥öÊñáÂ≠ó
            showModal("ÂçáËÅ∑ÂíØÔºÅ‚ú®", "", `${reason}\nÊÅ≠ÂñúÔºÅ‰Ω†Â∑≤ÂçáËá≥„Äê${newRank}„Äë\n(È™∞Â≠êÈÄ≤ÂåñÁÇ∫ D${p.dice})`);
            
            document.getElementById('close-btn').onclick = () => {
                document.getElementById('modal').style.display = 'none';
            };
            return false;
        }

        async function downgradeLogic(p) {
            // Â¶ÇÊûúÂ∑≤Á∂ìÊòØÊúÄ‰ΩéÈöéÔºåÂ∞±‰∏çÂÜçÈôçÁ¥ö
            if(p.dice === 4) return;
            
            const prevLv = { 15: 10, 10: 6, 6: 4 };
            p.dice = prevLv[p.dice];
            const newRank = rankNames[p.dice];
            
            updateUI();
            
            // ÈôçÁ¥öÈÄöÂ∏∏‰º¥Èö®Èö®Ê©ü‰∫ã‰ª∂ÔºåÈ°ØÁ§∫ÊèêÁ§∫ËÆìÁé©ÂÆ∂Áü•ÈÅìÊÖò‰∫Ü
            showModal("Ê≠êÂ∏ÉÔºÅüò©", "", `Áî±ÊñºÊÑèÂ§ñËÄΩË™§...\n‰Ω†Ë¢´ÈôçÊàê„Äê${newRank}„Äë\n(È™∞Â≠êÈÄÄÂåñÁÇ∫ D${p.dice})`);
            
            document.getElementById('close-btn').onclick = () => {
                document.getElementById('modal').style.display = 'none';
            };
        }

        function nextTurn() {
            isMoving = false;
            currentPlayerIdx = 1 - currentPlayerIdx;
            updateUI();
        }

        function updateUI() {
            players.forEach((p, i) => {
                const tag = document.getElementById(p.tag);
                const rank = rankNames[p.dice]; // ÂèñÂæóÁ®±Ëôü
                tag.innerText = `P${p.id}: ${rank} (D${p.dice})`;
                tag.classList.toggle('active', i === currentPlayerIdx);
                document.getElementById(`p${p.id}-status`).innerHTML = 
                    p.skipTurns > 0 ? `<span class="status-badge">Á§æÂçÄÊúçÂãô</span>` : 
                    (p.fixedSteps > 0 ? `<span class="status-badge">Á¥ØÁ¥ØÁóÖ</span>` : "");
                document.getElementById(p.token).classList.toggle('mini', p.skipTurns > 0);
            });
            document.getElementById('status-bar').innerText = `Ëº™Âà∞ Áé©ÂÆ∂ ${players[currentPlayerIdx].id}`;
        }

        function updateTokens() {
            players.forEach(p => {
                const cell = document.getElementsByClassName('cell')[p.pos];
                const boardRect = document.getElementById('game-container').getBoundingClientRect();
                const rect = cell.getBoundingClientRect();
                const el = document.getElementById(p.token);
                const offset = p.id === 1 ? -6 : 6;
                el.style.left = (rect.left - boardRect.left + rect.width/2 - 16 + offset) + 'px';
                el.style.top = (rect.top - boardRect.top + rect.height/2 - 16 + offset) + 'px';
            });
        }

        function showModal(t, img, txt) {
            document.getElementById('modal-title').innerText = t;
            const imgEl = document.getElementById('modal-img');
            if(img) { imgEl.src = img; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
            document.getElementById('modal-text').innerText = txt;
            document.getElementById('modal').style.display = 'flex';
        }

        function victory(p) {
            confetti({ particleCount: 300, spread: 150, origin: { y: 0.6 } });
            showModal("üéä ÁµÇÊ•µÂ§ßÈ©öÂñú üéä", "", `Áé©ÂÆ∂ ${p.id} ÊàêÁÇ∫ÁÑ°ÊâÄ‰∏çËÉΩÁöÑÂØ∏Á•ûÔºÅ\nÂ∏åÊúõ‰Ω†Áé©ÂæóÈñãÂøÉÔºåÁîüÊó•Âø´Ê®ÇÔºÅüíñ`);
            document.getElementById('dice-btn').style.pointerEvents = 'none';
            document.getElementById('close-btn').innerText = "ÂÜçÁé©‰∏ÄÊ¨°";
            document.getElementById('close-btn').onclick = () => location.reload();
        }

        document.getElementById('reset-btn').onclick = () => { if(confirm("Á¢∫ÂÆöÈáçÂïüÔºü")) location.reload(); };
        initBoard();
        window.onresize = updateTokens;
    </script>
</body>
</html>
