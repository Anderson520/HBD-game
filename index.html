<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›æ†¶å¤§å¯Œç¿ - ç”Ÿæ—¥é©šå–œ Vibe ç‰ˆ</title>
    <style>
        :root { --p1-color: #ff85a2; --p2-color: #4cc9f0; --accent-color: #f72585; --bg-color: #fff5f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        #status-bar { margin-top: 15px; font-size: 18px; font-weight: bold; color: #333; height: 30px; text-align: center; }
        
        #player-info { display: flex; gap: 10px; margin: 10px 0; }
        .p-tag { padding: 6px 12px; border-radius: 20px; font-size: 12px; background: white; border: 2px solid #ddd; transition: 0.3s; color: #888; position: relative; }
        .p-tag.active.p1-active { border-color: var(--p1-color); background: var(--p1-color); color: white; transform: scale(1.1); }
        .p-tag.active.p2-active { border-color: var(--p2-color); background: var(--p2-color); color: white; transform: scale(1.1); }
        .status-badge { position: absolute; top: -10px; right: -5px; font-size: 9px; background: #ff4d4d; color: white; padding: 2px 5px; border-radius: 8px; }

        #game-container { position: relative; width: 92vw; height: 92vw; max-width: 400px; max-height: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 10px; }
        .board { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); gap: 4px; width: 100%; height: 100%; }
        .cell { background: #fff0f3; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 11px; border: 1px solid #ffdeeb; position: relative; font-weight: bold; text-align: center; padding: 2px; }
        .cell.special { background: #ffd166; color: #555; border-color: #f4a261; }
        .cell.upgrade { background: #06d6a0; color: white; border-color: #059669; }
        .cell.start { background: var(--accent-color); color: white; }
        
        .player-token { position: absolute; width: 32px; height: 32px; z-index: 10; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .player-token.mini { transform: scale(0.6); opacity: 0.8; }

        .dice-box { width: 70px; height: 70px; background: white; border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: bold; color: var(--accent-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid var(--accent-color); margin: 15px 0; cursor: pointer; }
        .rolling-anim { animation: shake 0.1s infinite; color: #ccc; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        
        #reset-btn { background: #aaa; color: white; border: none; padding: 8px 20px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-bottom: 10px; }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 20px; text-align: center; }
        .modal-content img { width: 100%; max-height: 220px; border-radius: 12px; margin-bottom: 12px; object-fit: cover; display: none; }
        #modal-text { font-size: 16px; line-height: 1.5; color: #444; margin: 10px 0; font-weight: 500; }
        #close-btn { background: var(--accent-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 16px; width: 100%; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="status-bar">æº–å‚™å¥½é–‹å§‹å›æ†¶äº†å—ï¼Ÿ</div>
    <div id="player-info">
        <div id="p1-tag" class="p-tag p1-active active">P1: D4 <span id="p1-status"></span></div>
        <div id="p2-tag" class="p-tag p2-active">P2: D4 <span id="p2-status"></span></div>
    </div>

    <div id="game-container">
        <img id="p1-token" class="player-token" src="me.png" onerror="this.src='https://ui-avatars.com/api/?name=P1&background=ff85a2&color=fff'">
        <img id="p2-token" class="player-token" src="you.png" onerror="this.src='https://ui-avatars.com/api/?name=P2&background=4cc9f0&color=fff'">
        <div class="board" id="board"></div>
    </div>

    <div class="dice-box" id="dice-btn">?</div>
    <button id="reset-btn">é‡æ–°å•Ÿå‹•éŠæˆ²</button>

    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color: var(--accent-color); margin: 0 0 10px 0;"></h3>
            <img id="modal-img" src="">
            <div id="modal-text"></div>
            <button id="close-btn">ç¹¼çºŒå‰é€²</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // --- 1. é…ç½®å€åŸŸ ---
        const mapPhotos = ["p1.jpg", "p2.jpg", "p3.jpg", "p4.jpg", "p5.jpg", "p6.jpg", "p7.jpg", "p8.jpg", "p9.jpg", "p10.jpg"];
        const mapTexts = ["é‚£æ˜¯æˆ‘å€‘æœ€åˆçš„èµ·é»", "å¦³æœ€æ„›åƒçš„ä¸€é “é£¯", "é‚£æ¬¡åµæ¶å¾Œçš„å’Œå¥½", "æ˜Ÿç©ºä¸‹çš„æ‰¿è«¾", "ä¸€èµ·åŠªåŠ›çš„æ™‚å…‰", "å¦³ç¬‘å¾—æœ€é–‹å¿ƒçš„ç¬é–“", "æˆ‘å€‘å…±åŒçš„å¤¢æƒ³", "æ‰‹ç‰½æ‰‹çš„æº«åº¦", "å¦³æ˜¯æˆ‘çš„å”¯ä¸€", "ç”Ÿæ—¥å¿«æ¨‚ï¼Œæˆ‘çš„æ„›"];

        const eventPhotos = {
            mini: "e1.jpg",    // å‡å†’å¯¸ç¥
            tired: "e2.jpg",   // ç´¯ç´¯ç—…
            scratch: "e3.jpg", // æŠ“èƒŒ
            pokemon: "e4.jpg", // æŠ“å¯¶
            nuo: "e5.jpg",     // å°è«¾
            racing: "e6.jpg",  // é£†è»Š
            ceng: "e7.jpg"     // è¹­å­
        };

        // --- 2. éŠæˆ²æ ¸å¿ƒè®Šæ•¸ ---
        let players = [
            { id: 1, pos: 0, dice: 4, token: 'p1-token', tag: 'p1-tag', skipTurns: 0, fixedSteps: 0, reverseNext: false },
            { id: 2, pos: 0, dice: 4, token: 'p2-token', tag: 'p2-tag', skipTurns: 0, fixedSteps: 0, reverseNext: false }
        ];
        let currentPlayerIdx = 0;
        let isMoving = false;
        const totalCells = 20;
        const layout = ['Start','M','S','M','M','S','U','M','S','M','S','M','M','S','U','M','S','M','S','M'];
        const gridMap = [[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[6,5],[6,4],[6,3],[6,2],[6,1],[5,1],[4,1],[3,1],[2,1]];

        function initBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            let mIdx = 0;
            layout.forEach((type, i) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.gridRow = gridMap[i][0];
                cell.style.gridColumn = gridMap[i][1];
                if(type === 'Start') { cell.innerText = "START"; cell.classList.add('start'); }
                else if(type === 'S') { cell.innerText = "ï¼Ÿ"; cell.classList.add('special'); }
                else if(type === 'U') { cell.innerText = "UP"; cell.classList.add('upgrade'); }
                else { cell.innerText = "â¤"; cell.dataset.mIdx = mIdx % mapPhotos.length; mIdx++; }
                boardEl.appendChild(cell);
            });
            updateTokens();
            updateUI();
        }

        // --- 3. æ“²éª°å­èˆ‡ç§»å‹•é‚è¼¯ ---
        document.getElementById('dice-btn').onclick = function() {
            if(isMoving) return;
            let p = players[currentPlayerIdx];

            if(p.skipTurns > 0) {
                p.skipTurns--;
                showModal("ç¤¾å€æœå‹™ä¸­...", eventPhotos.mini, `é‚„éœ€è¦æœåˆ‘ ${p.skipTurns + 1} å›åˆã€‚`);
                document.getElementById('close-btn').onclick = () => {
                    document.getElementById('modal').style.display = 'none';
                    nextTurn();
                };
                return;
            }

            this.classList.add('rolling-anim');
            let counter = 0;
            let rollInterval = setInterval(() => {
                this.innerText = Math.floor(Math.random() * p.dice) + 1;
                if(++counter > 10) {
                    clearInterval(rollInterval);
                    let finalRoll = Math.floor(Math.random() * p.dice) + 1;
                    if(p.fixedSteps > 0) { p.fixedSteps--; finalRoll = 1; }
                    if(p.reverseNext) { p.reverseNext = false; finalRoll = -finalRoll; }
                    this.innerText = Math.abs(finalRoll);
                    this.classList.remove('rolling-anim');
                    movePlayer(p, finalRoll, true);
                }
            }, 80);
        };

        async function movePlayer(p, steps, triggerLanding = true) {
            isMoving = true;
            let direction = steps > 0 ? 1 : -1;
            let count = Math.abs(steps);

            for(let i=0; i<count; i++) {
                p.pos = (p.pos + direction + totalCells) % totalCells;
                updateTokens();
                if(p.pos === 0) {
                    if(direction === 1) { 
                        const win = await upgradeLogic(p, "é †åˆ©ç¹å®Œä¸€åœˆï¼"); 
                        if(win) return; 
                    } else { 
                        await downgradeLogic(p); 
                    }
                }
                await new Promise(r => setTimeout(r, 280));
            }
            if(triggerLanding) handleLanding(p);
        }

        function handleLanding(p) {
            const type = layout[p.pos];
            if(type === 'U') {
                upgradeLogic(p, "è¸©åˆ°å‡ç´šæ ¼ï¼").then(win => { if(!win) nextTurn(); });
            } else if(type === 'S') {
                triggerRandomEvent(p);
            } else if(document.getElementsByClassName('cell')[p.pos].dataset.mIdx !== undefined) {
                const idx = document.getElementsByClassName('cell')[p.pos].dataset.mIdx;
                showModal("é‚£ä¸€å¹´...", mapPhotos[idx], mapTexts[idx]);
                document.getElementById('close-btn').onclick = () => { document.getElementById('modal').style.display = 'none'; nextTurn(); };
            } else {
                nextTurn();
            }
        }

        // --- 4. éš¨æ©Ÿäº‹ä»¶é‚è¼¯ (å«ç…§ç‰‡) ---
        function triggerRandomEvent(p) {
            const events = [
                {
                    f: () => {
                        p.skipTurns = 2;
                        showModal("å‡å†’å¯¸ç¥ï¼Œè¢«è²¶ç‚ºè¿·ä½ å¯¸", eventPhotos.mini, "ä¸‹å…©å›åˆä¸èƒ½æ“²éª°å­ï¼šç¤¾å€æœå‹™ä¸­...");
                    }
                },
                {
                    f: () => {
                        p.fixedSteps = 3;
                        showModal("ç´¯ç´¯ç—…ç™¼ä½œ", eventPhotos.tired, "ä¸‹ä¸‰å›åˆåªèƒ½èµ°ä¸€æ­¥ã€‚");
                    }
                },
                {
                    f: () => {
                        const opp = players[1 - currentPlayerIdx];
                        showModal("æä¾›æŠ“èƒŒæœå‹™", eventPhotos.scratch, "è‡ªå·±å‡ç´šï¼Œå°æ–¹å‰é€²ä¸‰æ ¼ï¼");
                        upgradeLogic(p, "æŠ“èƒŒçå‹µ");
                        movePlayer(opp, 3, false);
                    }
                },
                {
                    f: () => {
                        p.reverseNext = true;
                        showModal("æ²ˆè¿·æŠ“å¯¶è¿·è·¯äº†", eventPhotos.pokemon, "ä¸‹å›åˆè‡ªå·±å¾€å¾Œèµ°ã€‚");
                    }
                },
                {
                    f: () => {
                        showModal("è¢«å°è«¾é¨·æ“¾è€½èª¤", eventPhotos.nuo, "å¾€å¾Œé€€ 3 æ ¼ã€‚");
                        setTimeout(() => movePlayer(p, -3, true), 800);
                        return true;
                    }
                },
                {
                    f: () => {
                        showModal("é£†è»Šï¼", eventPhotos.racing, "å…©äººä¸€èµ·å‰é€² 4 æ ¼ï¼");
                        movePlayer(players[0], 4, false);
                        movePlayer(players[1], 4, false);
                    }
                },
                {
                    f: () => {
                        showModal("å’Œè¹­å­ç©", eventPhotos.ceng, "ä»€éº¼äº‹éƒ½æ²’ç™¼ç”Ÿï¼Œä½†å¾ˆå¯æ„›ã€‚");
                    }
                }
            ];

            const ev = events[Math.floor(Math.random() * events.length)];
            const isAsync = ev.f();
            document.getElementById('close-btn').onclick = () => {
                document.getElementById('modal').style.display = 'none';
                if(!isAsync) nextTurn();
            };
        }

        // --- 5. å‡é™ç´šèˆ‡ UI ---
        async function upgradeLogic(p, reason) {
            if(p.dice === 15) { victory(p); return true; }
            const lv = { 4: 6, 6: 10, 10: 15 };
            p.dice = lv[p.dice];
            updateUI();
            showModal("LEVEL UP!", "", `${reason}\néª°å­é€²åŒ–ç‚º D${p.dice}ï¼`);
            document.getElementById('close-btn').onclick = () => document.getElementById('modal').style.display = 'none';
            return false;
        }

        async function downgradeLogic(p) {
            const lv = { 15: 10, 10: 6, 6: 4, 4: 4 };
            p.dice = lv[p.dice];
            updateUI();
        }

        function nextTurn() {
            isMoving = false;
            currentPlayerIdx = 1 - currentPlayerIdx;
            updateUI();
        }

        function updateUI() {
            players.forEach((p, i) => {
                const tag = document.getElementById(p.tag);
                tag.innerText = `P${p.id}: D${p.dice}`;
                tag.classList.toggle('active', i === currentPlayerIdx);
                document.getElementById(`p${p.id}-status`).innerHTML = 
                    p.skipTurns > 0 ? `<span class="status-badge">ç¤¾å€æœå‹™</span>` : 
                    (p.fixedSteps > 0 ? `<span class="status-badge">ç´¯ç´¯ç—…</span>` : "");
                document.getElementById(p.token).classList.toggle('mini', p.skipTurns > 0);
            });
            document.getElementById('status-bar').innerText = `è¼ªåˆ° ç©å®¶ ${players[currentPlayerIdx].id}`;
        }

        function updateTokens() {
            players.forEach(p => {
                const cell = document.getElementsByClassName('cell')[p.pos];
                const boardRect = document.getElementById('game-container').getBoundingClientRect();
                const rect = cell.getBoundingClientRect();
                const el = document.getElementById(p.token);
                const offset = p.id === 1 ? -6 : 6;
                el.style.left = (rect.left - boardRect.left + rect.width/2 - 16 + offset) + 'px';
                el.style.top = (rect.top - boardRect.top + rect.height/2 - 16 + offset) + 'px';
            });
        }

        function showModal(t, img, txt) {
            document.getElementById('modal-title').innerText = t;
            const imgEl = document.getElementById('modal-img');
            if(img) { imgEl.src = img; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
            document.getElementById('modal-text').innerText = txt;
            document.getElementById('modal').style.display = 'flex';
        }

        function victory(p) {
            confetti({ particleCount: 300, spread: 150, origin: { y: 0.6 } });
            showModal("ğŸŠ çµ‚æ¥µå¤§é©šå–œ ğŸŠ", "", `ç©å®¶ ${p.id} å®Œæˆäº† D15 çµ‚æ¥µå‡ç´šï¼\nå¦³æ˜¯é€™æ®µæ—…ç¨‹æœ€ç¾çš„é¢¨æ™¯ï¼Œç”Ÿæ—¥å¿«æ¨‚ï¼ğŸ’–`);
            document.getElementById('dice-btn').style.pointerEvents = 'none';
            document.getElementById('close-btn').innerText = "å†ç©ä¸€æ¬¡";
            document.getElementById('close-btn').onclick = () => location.reload();
        }

        document.getElementById('reset-btn').onclick = () => { if(confirm("ç¢ºå®šé‡å•Ÿï¼Ÿ")) location.reload(); };
        initBoard();
        window.onresize = updateTokens;
    </script>
</body>
</html>
